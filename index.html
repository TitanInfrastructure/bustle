<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Bustle by fredwu</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Bustle</h1>
        <p>Activities recording and retrieving using a simple Pub/Sub architecture.</p>
        <p class="view"><a href="https://github.com/fredwu/bustle">View the Project on GitHub <small>fredwu/bustle</small></a></p>
        <ul>
          <li><a href="https://github.com/fredwu/bustle/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/fredwu/bustle/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/fredwu/bustle">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>Bustle <a href="http://travis-ci.org/fredwu/bustle"><img src="https://secure.travis-ci.org/fredwu/bustle.png?branch=master" alt="Build Status"></a> <a href="https://gemnasium.com/fredwu/bustle"><img src="https://gemnasium.com/fredwu/bustle.png" alt="Dependency Status"></a> <a href="https://codeclimate.com/github/fredwu/bustle"><img src="https://codeclimate.com/badge.png" alt="Code Climate"></a>
</h1>

<p>Activities recording and retrieving using a simple Pub/Sub-like interface.</p>

<p>The typical use cases are:</p>

<ul>
<li>Timeline (e.g. tracking activities such as posting and commenting for users)</li>
<li>Logging</li>
</ul><p>The advantages of Bustle are:</p>

<ul>
<li>It is lightweight and simple to use</li>
<li>It is largely self-contained and separated from you core app logic</li>
<li>It works nicely with ActiveRecord out of box</li>
<li>It is ORM-agnostic therefore can be extended to use with other databases</li>
<li>It has full unit test coverage</li>
</ul><p>Bustle is built for simplicity and extensibility. If you are after high performance pub/sub then this gem is not for you.</p>

<h2>Installation</h2>

<p>Add this line to your application's Gemfile:</p>

<div class="highlight">
<pre><span class="n">gem</span> <span class="s1">'bustle'</span>
</pre>
</div>


<h2>Usage</h2>

<h3>Configuration</h3>

<p>First of all, you will need to configure Bustle. If you are using Rails, you can put the following code in an initializer (e.g. <code>config/initializers/bustle.rb</code>).</p>

<div class="highlight">
<pre><span class="no">Bustle</span><span class="o">.</span><span class="n">config</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="c1"># Specify a storage strategy for storing activities</span>
  <span class="c1"># Bustle ships with an ActiveRecord storage strategy</span>
  <span class="n">c</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="no">Bustle</span><span class="o">::</span><span class="no">Storage</span><span class="o">::</span><span class="no">ActiveRecord</span>
<span class="k">end</span>
</pre>
</div>


<p>For ActiveRecord, you will need the following migration file:</p>

<div class="highlight">
<pre><span class="k">class</span> <span class="nc">CreateBustleTables</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:bustle_activities</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span>  <span class="ss">:resource_class</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:resource_id</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span>  <span class="ss">:action</span><span class="p">,</span>       <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s1">''</span>
      <span class="n">t</span><span class="o">.</span><span class="n">text</span>    <span class="ss">:data</span><span class="p">,</span>         <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s1">''</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:publisher_id</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:bustle_publishers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span>  <span class="ss">:resource_class</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:resource_id</span><span class="p">,</span>    <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:bustle_subscribers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span>  <span class="ss">:resource_class</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:resource_id</span><span class="p">,</span>    <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:bustle_subscriptions</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:publisher_id</span><span class="p">,</span>  <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:subscriber_id</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:bustle_activities</span><span class="p">,</span> <span class="ss">:publisher_id</span>
    <span class="n">add_index</span> <span class="ss">:bustle_publishers</span><span class="p">,</span> <span class="o">[</span><span class="ss">:resource_class</span><span class="p">,</span> <span class="ss">:resource_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>
    <span class="n">add_index</span> <span class="ss">:bustle_subscribers</span><span class="p">,</span> <span class="o">[</span><span class="ss">:resource_class</span><span class="p">,</span> <span class="ss">:resource_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>
    <span class="n">add_index</span> <span class="ss">:bustle_subscriptions</span><span class="p">,</span> <span class="ss">:publisher_id</span>
    <span class="n">add_index</span> <span class="ss">:bustle_subscriptions</span><span class="p">,</span> <span class="ss">:subscriber_id</span>
    <span class="n">add_index</span> <span class="ss">:bustle_subscriptions</span><span class="p">,</span> <span class="o">[</span><span class="ss">:publisher_id</span><span class="p">,</span> <span class="ss">:subscriber_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<h3>Flow</h3>

<p>Upon subscribing:</p>

<ol>
<li>Subscriber registers itself if not already registered</li>
<li>Publisher registers itself if not already registered</li>
<li>A Subscription is created for Subscriber and Publisher</li>
</ol><p>When activities occur:</p>

<ol>
<li>Publisher registers itself if not already registered</li>
<li>Publisher publishes activity</li>
</ol><h3>API</h3>

<h4>Register a Subscriber</h4>

<div class="highlight">
<pre><span class="c1"># returns a subscriber instance upon duplicated entry</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscribers</span><span class="o">.</span><span class="n">add</span> <span class="n">subscriber</span>
<span class="c1"># raises error upon duplicated entry</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscribers</span><span class="o">.</span><span class="n">add!</span> <span class="n">subscriber</span>

<span class="c1"># example</span>
<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscribers</span><span class="o">.</span><span class="n">add</span> <span class="n">user</span>
</pre>
</div>


<h4>Register a Publisher</h4>

<div class="highlight">
<pre><span class="c1"># returns a publisher instance upon duplicated entry</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Publishers</span><span class="o">.</span><span class="n">add</span> <span class="n">publisher</span>
<span class="c1"># raises error upon duplicated entry</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Publishers</span><span class="o">.</span><span class="n">add!</span> <span class="n">publisher</span>

<span class="c1"># example</span>
<span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Publishers</span><span class="o">.</span><span class="n">add</span> <span class="n">post</span>
</pre>
</div>


<h4>Create a Subscription</h4>

<div class="highlight">
<pre><span class="c1"># returns a subscription instance upon duplicated entry</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscriptions</span><span class="o">.</span><span class="n">add</span> <span class="n">bustle_publisher</span><span class="p">,</span> <span class="n">bustle_subscriber</span>
<span class="c1"># raises error upon duplicated entry</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscriptions</span><span class="o">.</span><span class="n">add!</span> <span class="n">bustle_publisher</span><span class="p">,</span> <span class="n">bustle_subscriber</span>

<span class="c1"># example</span>
<span class="n">publisher</span>  <span class="o">=</span> <span class="no">Bustle</span><span class="o">::</span><span class="no">Publishers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="no">Post</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
<span class="n">subscriber</span> <span class="o">=</span> <span class="no">Bustle</span><span class="o">::</span><span class="no">Subscribers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscriptions</span><span class="o">.</span><span class="n">add</span> <span class="n">publisher</span><span class="p">,</span> <span class="n">subscriber</span>
</pre>
</div>


<h4>Find a Subscriber/Publisher/Subscription</h4>

<div class="highlight">
<pre><span class="no">Bustle</span><span class="o">::</span><span class="no">Subscribers</span><span class="o">.</span><span class="n">get</span> <span class="n">subscriber</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Publishers</span><span class="o">.</span><span class="n">get</span> <span class="n">publisher</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscriptions</span><span class="o">.</span><span class="n">get</span> <span class="n">bustle_publisher</span><span class="p">,</span> <span class="n">bustle_subscriber</span> <span class="c1"># =&gt; Bustle::Subscription</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscriptions</span><span class="o">.</span><span class="n">by</span> <span class="n">bustle_publisher</span> <span class="c1"># =&gt; an array of Bustle::Subscription by the publisher</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscriptions</span><span class="o">.</span><span class="n">for</span> <span class="n">bustle_subscriber</span> <span class="c1"># =&gt; an array of Bustle::Subscription for the subscriber</span>
</pre>
</div>


<h4>Remove a Subscriber/Publisher/Subscription</h4>

<div class="highlight">
<pre><span class="no">Bustle</span><span class="o">::</span><span class="no">Subscribers</span><span class="o">.</span><span class="n">remove</span> <span class="n">subscriber</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Publishers</span><span class="o">.</span><span class="n">remove</span> <span class="n">publisher</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscriptions</span><span class="o">.</span><span class="n">remove</span> <span class="n">bustle_publisher</span><span class="p">,</span> <span class="n">bustle_subscriber</span>
<span class="c1"># or use `remove!` to raise an exception if the resource cannot be found</span>
</pre>
</div>


<p>Or:</p>

<div class="highlight">
<pre><span class="no">Bustle</span><span class="o">::</span><span class="no">Subscribers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Publishers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">publisher</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscriptions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bustle_publisher</span><span class="p">,</span> <span class="n">bustle_subscriber</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre>
</div>


<h4>Find Referenced Resources</h4>

<p>These are helpful for finding referenced resources.</p>

<div class="highlight">
<pre><span class="no">Bustle</span><span class="o">::</span><span class="no">Activity</span><span class="c1">#publisher_resource</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Activity</span><span class="c1">#target_resource</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Publisher</span><span class="c1">#target_resource</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscriber</span><span class="c1">#target_resource</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscription</span><span class="c1">#publisher_resource</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscription</span><span class="c1">#subscriber_resource</span>
</pre>
</div>


<h4>Publish an Activity</h4>

<div class="highlight">
<pre><span class="no">Bustle</span><span class="o">::</span><span class="no">Activities</span><span class="o">.</span><span class="n">add</span> <span class="n">bustle_publisher</span><span class="p">,</span> <span class="p">{</span>
  <span class="ss">:resource</span> <span class="o">=&gt;</span> <span class="n">some_resource</span><span class="p">,</span>
  <span class="ss">:action</span>   <span class="o">=&gt;</span> <span class="n">some_string</span><span class="p">,</span>
  <span class="ss">:data</span>     <span class="o">=&gt;</span> <span class="n">some_text</span>
<span class="p">}</span>
<span class="c1"># or</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">({</span>
  <span class="ss">:resource</span> <span class="o">=&gt;</span> <span class="n">some_resource</span><span class="p">,</span>
  <span class="ss">:action</span>   <span class="o">=&gt;</span> <span class="n">some_string</span><span class="p">,</span>
  <span class="ss">:data</span>     <span class="o">=&gt;</span> <span class="n">some_text</span>
<span class="p">})</span>

<span class="c1"># example</span>
<span class="n">post</span>    <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">comment</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">"I'm a comment"</span><span class="p">)</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Publishers</span><span class="o">.</span><span class="n">add</span> <span class="n">post</span>
<span class="n">publisher</span> <span class="o">=</span> <span class="no">Bustle</span><span class="o">::</span><span class="no">Publishers</span><span class="o">.</span><span class="n">get</span> <span class="n">post</span>
<span class="n">publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">({</span>
  <span class="ss">:resource</span> <span class="o">=&gt;</span> <span class="n">comment</span><span class="p">,</span>
  <span class="ss">:action</span>   <span class="o">=&gt;</span> <span class="s1">'new'</span><span class="p">,</span>
  <span class="ss">:data</span>     <span class="o">=&gt;</span> <span class="s1">'useful for putting serialized data or JSON here'</span>
<span class="p">})</span>
</pre>
</div>


<h4>Activities</h4>

<h5>Retrieve Activities for a Subscriber</h5>

<div class="highlight">
<pre><span class="no">Bustle</span><span class="o">::</span><span class="no">Activities</span><span class="o">.</span><span class="n">for</span> <span class="n">bustle_subscriber</span>
<span class="c1"># or</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscriber</span><span class="o">.</span><span class="n">activities</span>

<span class="c1"># example</span>
<span class="n">subscriber</span> <span class="o">=</span> <span class="no">Bustle</span><span class="o">::</span><span class="no">Subscribers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
<span class="n">subscriber</span><span class="o">.</span><span class="n">activities</span>
</pre>
</div>


<h5>Retrieve Activities by a Publisher</h5>

<div class="highlight">
<pre><span class="no">Bustle</span><span class="o">::</span><span class="no">Activities</span><span class="o">.</span><span class="n">by</span> <span class="n">bustle_publisher</span>
<span class="c1"># or</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Publisher</span><span class="o">.</span><span class="n">activities</span>

<span class="c1"># example</span>
<span class="n">publisher</span> <span class="o">=</span> <span class="no">Bustle</span><span class="o">::</span><span class="no">Publishers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="no">Post</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
<span class="n">publisher</span><span class="o">.</span><span class="n">activities</span>
</pre>
</div>


<h4>Filtering (for Activities and Subscriptions)</h4>

<div class="highlight">
<pre><span class="no">Bustle</span><span class="o">::</span><span class="no">Activities</span><span class="o">.</span><span class="n">filter</span> <span class="ss">:key</span> <span class="o">=&gt;</span> <span class="ss">:value</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscriptions</span><span class="o">.</span><span class="n">filter</span> <span class="ss">:key</span> <span class="o">=&gt;</span> <span class="ss">:value</span>
<span class="c1"># or</span>
<span class="no">Bustle</span><span class="o">::</span><span class="no">Subscriber</span><span class="o">.</span><span class="n">activities</span> <span class="ss">:key</span> <span class="o">=&gt;</span> <span class="ss">:value</span>

<span class="c1"># example</span>
<span class="n">subscriber</span> <span class="o">=</span> <span class="no">Bustle</span><span class="o">::</span><span class="no">Subscribers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
<span class="n">subscriber</span><span class="o">.</span><span class="n">activities</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s1">'new'</span>
</pre>
</div>


<h2>License</h2>

<p>This gem is released under the <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a>.</p>

<h2>Author</h2>

<p><a href="https://github.com/fredwu">Fred Wu</a>, originally built for <a href="http://500.co">500 Startups</a>.</p>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/fredwu">fredwu</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
    
  </body>
</html>